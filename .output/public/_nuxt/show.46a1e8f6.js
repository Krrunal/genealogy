import{d as p,a as _,y as m,U as y,I as x,L as b,X as v}from"./index.1bf5856a.js";import{a as $,bx as S,r as w,o as U,b as E,h as k,e as f}from"./entry.92cc3846.js";import"./text.2058c26f.js";import"./json.3f897cba.js";import"./tree.65d50c14.js";const u={...p,tip:_()};Array.prototype.remove=function(){let t;const e=arguments;let s=e.length,n;for(;s&&this.length;)for(t=e[--s];(n=this.indexOf(t))!==-1;)this.splice(n,1);return this};const C={layout:"auth",components:{vSelect:S},data:()=>({persons:[],selected_option:null,data:{},all_nodes:[],tree:null,dag:null,svg:null,g:null,tip:null,duration:750,zoom:null,isLoading:!0,fullPage:!0,color:"#4fcf8d",backgroundColor:"#ffffff"}),mounted(){this.fetchdata()},async created(){this.persons=await this.$axios.$get("/api/person")},methods:{async setSelected(t){this.isLoading=!0;const e={start_id:t};try{await this.$axios.$get("/api/tree/show",{params:e}),this.data=gedcom,this.data.links=this.data.links.map(s=>s.map(n=>n.toString())),u.selectAll("#tree").selectAll("svg").remove(),this.isLoading=!1}catch{}this.isLoading=!1},async fetchdata(){this.isLoading=!0;try{this.data=sampleData,this.isLoading=!1,this.generate()}catch{}this.isLoading=!1},generate(){Object.keys(this.data.unions).forEach(a=>this.data.unions[a].isUnion=!0),Object.keys(this.data.persons).forEach(a=>this.data.persons[a].isUnion=!1);const t={top:20,right:0,bottom:30,left:0},e=1500-t.left-t.right,s=800-t.top-t.bottom,n=e,r=s;this.zoom=u.zoom().on("zoom",(a,g)=>this.g.attr("transform",a.transform)),this.tip=u.tip.attr("class","d3-tip").direction("e").offset([0,5]).html(a=>a.data.isUnion?void 0:`
              <span style='margin-left: 2.5px;'><b>${a.data.name}</b></span><br>
                <table style="margin-top: 2.5px;">
                  <tr><td>born</td><td>${a.data.birthyear||"?"} in ${a.data.birthplace||"?"}</td></tr>
                  <tr><td>died</td><td>${a.data.deathyear||"?"} in ${a.data.deathplace||"?"}</td></tr>
                </table>`.replace(new RegExp("null","g"),"?")),this.svg=u.select("#tree").append("svg").attr("width",n).attr("height",r).call(this.zoom).call(this.tip),this.g=this.svg.append("g");const d=120,h=50;try{this.tree=m().nodeSize(()=>[h,d]).layering(y()).decross(x()).coord(b())}catch{}if(this.dag=v()(this.data.links),this.dag.id){const a=this.dag.copy();a.id=void 0,this.dag=a}this.all_nodes=this.dag.descendants(),this.all_nodes.forEach(a=>{a.data=this.data.persons[a.data.id]?this.data.persons[a.data.id]:this.data.unions[a.data.id],a.childrens=a.children(),a._children=a.children(),a.inserted_nodes=[],a.inserted_roots=[],a.neighbors=[],a.visible=!1,a.inserted_connections=[]});const l=this.all_nodes.find(a=>a.data.id===this.data.start);l.visible=!0,l.neighbors=[],l.neighbors=this.getNeighbors(l),l.x0=r/2,l.y0=n/2,console.log("root.neighbors ====",l.neighbors),console.log("root.dag ====",this.dag),this.update(l)},remove_inserted_root_nodes(t){t.inserted_connections.forEach(e=>{e[0].childrens.includes(e[1])&&(e[0]._children.push(e[1]),e[0].childrens.remove(e[1]))}),t.inserted_nodes.forEach(this.remove_inserted_root_nodes)},collapse(t){this.remove_inserted_root_nodes(t);const e=t.neighbors.filter(s=>s.visible&&t.inserted_nodes.includes(s));console.log("vis_inserted_neighbors =======",e),e.forEach(s=>{s.visible=!1,t.childrens.includes(s)&&(t._children.push(s),t.childrens.remove(s)),s.childrens.includes(t)&&(s._children.push(t),s.childrens.remove(t)),s.data.isUnion&&this.collapse(s),t.inserted_nodes.remove(s)})},add_root_nodes(t){t.inserted_connections.forEach(e=>{e[0]._children.includes(e[1])&&(e[0].childrens.push(e[1]),e[0]._children.remove(e[1]))}),t.inserted_nodes.forEach(this.add_root_nodes)},uncollapse(t,e){if(t===void 0)return;const s=t.neighbors.filter(r=>r.visible);console.log("extended_neighbors =======",s),s.forEach(r=>{t._children.includes(r)&&t.inserted_connections.push([t,r]),r._children.includes(t)&&t.inserted_connections.push([r,t])}),t.neighbors.filter(r=>!r.visible).forEach(r=>{r.neighbors=this.getNeighbors(r),r.visible=!0,t._children.includes(r)&&(t.childrens.push(r),t._children.remove(r)),r._children.includes(t)&&(r.childrens.push(t),r._children.remove(t),e&&!t.inserted_roots.includes(r)&&t.inserted_roots.push(r)),r.data.isUnion&&this.uncollapse(r,!0),t.inserted_nodes.push(r)}),e||this.add_root_nodes(t)},is_extendable(t){return t.neighbors.filter(e=>!e.visible).length>0},getNeighbors(t){return t.data.isUnion?this.getChildren(t).concat(this.getPartners(t)):this.getOwnUnions(t).concat(this.getParentUnions(t))},getParentUnions(t){if(t===void 0)return[];if(t.data.isUnion)return[];const e=t.data.parent_union;return e?[this.all_nodes.find(n=>n.data.id===e)].filter(n=>n!==void 0):[]},getParents(t){let e=[];return t.data.isUnion?t.data.partner.forEach(s=>e.push(this.all_nodes.find(n=>n.data.id===s))):this.getParentUnions(t).forEach(n=>e=e.concat(this.getParents(n))),e.filter(s=>s!==void 0)},getOtherPartner(t,e){const s=e.partner.find(n=>n!==t.data.id&&n!==void 0);return this.all_nodes.find(n=>n.data.id===s)},getPartners(t){const e=[];return t.data.isUnion?t.data.partner.forEach(s=>e.push(this.all_nodes.find(n=>n.data.id===s))):this.getOwnUnions(t).forEach(n=>{e.push(this.getOtherPartner(t,n.data))}),e.filter(s=>s!==void 0)},getOwnUnions(t){if(t.data.isUnion)return[];const e=[];return t.data.own_unions.forEach(s=>e.push(this.all_nodes.find(n=>n.data.id===s))),e.filter(s=>s!==void 0)},getChildren(t){let e=[];return t.data.isUnion?e=t.childrens.concat(t._children):this.getOwnUnions(t).forEach(n=>e=e.concat(this.getChildren(n))),e=e.filter(s=>s!==void 0).sort((s,n)=>Math.sign((this.getBirthYear(s)||0)-(this.getBirthYear(n)||0))),e},getBirthYear(t){return new Date(t.data.birthyear||NaN).getFullYear()},getDeathYear(t){return new Date(t.data.deathyear||NaN).getFullYear()},find_path(t){const e=this.getParents(t);let s=!1,n=null;return e.forEach(r=>{r&&!s&&(r.id==="profile-89285291"?(s=!0,n=[r,t]):(n=this.find_path(r),n&&(s=!0,n.push(t))))}),n},update(t){if(console.log("update dag ====== ",this.dag),t.data.id!==this.data.start)return!1;this.tree(this.dag);const e=this.dag.descendants(),s=this.dag.links(),n=this.g.selectAll("g.node").data(e,o=>o.data.id||(o.data.id=++i)),r=n.enter().append("g").attr("class","node").attr("transform",o=>`translate(${t.y0},${t.x0})`).on("click",this.onClick).on("mouseover",(o,c)=>this.tip.show(c,o.target)).on("mouseout",(o,c)=>this.tip.hide(c,o.target)).attr("visibility","visible");r.append("circle").attr("class","node").attr("r",1e-6).style("fill",o=>this.is_extendable(o)?"lightsteelblue":"#fff"),r.append("text").attr("dy","-2").attr("x",13).attr("text-anchor","start").text(o=>o.data.name),r.append("text").attr("dy","10").attr("x",13).attr("text-anchor","start").text(o=>{if(!o.data.isUnion)return`${o.data.birthyear||"?"} - ${o.data.deathyear||"?"}`});const d=r.merge(n);d.transition().duration(this.duration).attr("transform",o=>`translate(${o.y},${o.x})`),d.select("circle.node").attr("r",o=>10*!o.data.isUnion).style("fill",o=>this.is_extendable(o)?"lightsteelblue":"#fff").attr("cursor","pointer");const h=n.exit().transition().duration(this.duration).attr("transform",o=>`translate(${t.y},${t.x})`).attr("visibility","hidden").remove();h.select("circle").attr("r",1e-6),h.select("text").style("fill-opacity",1e-6);const l=this.g.selectAll("path.link").data(s,o=>o.source.id+o.target.id);l.enter().insert("path","g").attr("class","link").attr("d",o=>{const c={x:t.x0,y:t.y0};return this.diagonal(c,c)}).merge(l).transition().duration(this.duration).attr("d",o=>this.diagonal(o.source,o.target)),l.exit().transition().duration(this.duration).attr("d",o=>{const c={x:t.x,y:t.y};return this.diagonal(c,c)}).remove(),this.svg.transition().duration(this.duration).call(this.zoom.transform,u.zoomTransform(this.g.node()).translate(-(t.y-t.y0),-(t.x-t.x0))),e.forEach(o=>{o.x0=o.x,o.y0=o.y}),u.select("#saveButton").on("click",()=>{const o=this.getSVGString(this.svg.node());this.svgString2Image(o,2*width,2*height,"png",this.onSave)})},diagonal(t,e){return`M ${t.y} ${t.x}
                C ${(t.y+e.y)/2} ${t.x},
                  ${(t.y+e.y)/2} ${e.x},
                  ${e.y} ${e.x}`},getCSSStyles(t){const e=[];e.push(`#${t.id}`);for(let d=0;d<t.classList.length;d++)r(`.${t.classList[d]}`,e)||e.push(`.${t.classList[d]}`);const s=t.getElementsByTagName("*");for(let d=0;d<s.length;d++){const{id:h}=s[d];r(`#${h}`,e)||e.push(`#${h}`);const l=s[d].classList;for(let a=0;a<l.length;a++)r(`.${l[a]}`,e)||e.push(`.${l[a]}`)}let n="";for(let d=0;d<document.styleSheets.length;d++){const h=document.styleSheets[d];try{if(!h.cssRules)continue}catch(a){if(a.name!=="SecurityError")throw a;continue}const{cssRules:l}=h;for(let a=0;a<l.length;a++)r(l[a].selectorText,e)&&(n+=l[a].cssText)}return n;function r(d,h){return h.indexOf(d)!==-1}},appendCSS(t,e){const s=document.createElement("style");s.setAttribute("type","text/css"),s.innerHTML=t;const n=e.hasChildNodes()?e.children[0]:null;e.insertBefore(s,n)},getSVGString(t){t.setAttribute("xlink","http://www.w3.org/1999/xlink");const e=this.getCSSStyles(t);this.appendCSS(e,t);let n=new XMLSerializer().serializeToString(t);return n=n.replace(/(\w+)?:?xlink=/g,"xmlns:xlink="),n=n.replace(/NS\d+:href/g,"xlink:href"),n},svgString2Image(t,e,s,n,r){const d=`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(t)))}`,h=document.createElement("canvas"),l=h.getContext("2d");h.width=e,h.height=s;const a=new Image;a.onload=()=>{l.clearRect(0,0,e,s),l.drawImage(a,0,0,e,s),h.toBlob(g=>{const o=`${Math.round(g.length/1024)} KB`;r&&r(g,o)})},a.src=d},onClick(t,e){e.data.isUnion||(console.log("click d ===============",this.is_extendable(e)),this.is_extendable(e)?this.uncollapse(e):this.collapse(e),this.update(e))},onSave(t,e){}}},L=f("div",{id:"tree"},null,-1),z=f("button",{id:"saveButton"},"Export my PNG",-1);function B(t,e,s,n,r,d){const h=w("v-select");return U(),E("div",null,[k(h,{label:"name",modelValue:t.selected_option,"onUpdate:modelValue":e[0]||(e[0]=l=>t.selected_option=l),reduce:l=>l.id,options:t.persons,onInput:d.setSelected},null,8,["modelValue","reduce","options","onInput"]),L,z])}const A=$(C,[["render",B]]);export{A as default};
