import{a as g,o as a,b as r,e as n,t as m,l as k,k as x,m as q,p as V,q as E,s as T,v as j,w as $,r as c,F as y,x as b,y as _,h as d,z as w}from"./entry.92cc3846.js";import"./EnsoDatepicker.9c00621a.js";import{E as C}from"./EnsoDateFilter.2eb18b56.js";import"./VueSelect.b511f2f3.js";import{E as F}from"./EnsoSelectFilter.6aa28328.js";import"./strings.38ce49d3.js";import"./focus.3e4288bb.js";import"./SearchMode.06b93769.js";import"./EnsoSelect.8229d59e.js";const R={name:"Event",inject:["i18n","route","routerErrorHandler"],props:{event:{type:Object,required:!0}},computed:{message(){return Object.keys(this.event.meta.attributes).reduce((e,t)=>e.split(`:${t}`).join(this.label(t)),this.parsedMessage)},parsedMessage(){return Array.isArray(this.event.meta.message)?this.event.meta.message.map(e=>this.i18n(e)).join(" "):this.event.meta.message}},methods:{label(e){const{attributes:t}=this.event.meta;return["user","label"].includes(e)?`<strong>${t[e]}</strong>`:t[e]}}},A={class:"media box has-background-light p-2 raises-on-hover"},I={class:"media-left mt-1"},L={class:"image is-32x32"},S=["src"],B={class:"event"},H={class:"heading"},M=["innerHTML"];function D(e,t,s,p,v,i){return a(),r("article",A,[n("figure",I,[n("p",L,[n("img",{class:"is-rounded is-clickable",src:i.route("core.avatars.show",s.event.owner.avatar.id),onClick:t[0]||(t[0]=u=>e.$router.push({name:"administration.users.show",params:{user:s.event.owner.id}}))},null,8,S)])]),n("div",B,[n("p",H,m(s.event.time),1),n("p",{innerHTML:i.message},null,8,M)])])}const N=g(R,[["render",D]]);k.add(x,q,V,E,T,j);const U={name:"Timeline",components:{Event:N},inject:["i18n"],props:{feed:{type:Array,required:!0},loading:{type:Boolean,required:!0}},computed:{...$("layout",["isTouch"]),days(){return this.feed.reduce()}},methods:{formatDate(e){return this.$format(e,"l F d")}}},z={class:"activity-log"},O={key:0,class:"title is-4 has-text-centered"},P={class:"timeline-header"},W={class:"tag is-medium is-bold is-primary"},G={class:"icon is-small has-text-white"},J={class:"timeline-content"},K={key:2,class:"has-text-centered"};function Q(e,t,s,p,v,i){const u=c("fa"),h=c("event");return a(),r("div",z,[s.feed.length?(a(!0),r(y,{key:1},b(s.feed,(o,l)=>(a(),r("div",{class:_(["timeline animated fadeIn",{"is-centered":!e.isTouch}]),key:`${o}-${l}`},[n("header",P,[n("span",W,m(i.formatDate(o.date)),1)]),(a(!0),r(y,null,b(o.entries,f=>(a(),r("div",{class:"timeline-item",key:f.id},[n("div",{class:_(["timeline-marker is-icon",f.meta.iconClass])},[n("span",G,[d(u,{icon:f.meta.icon,size:"xs"},null,8,["icon"])])],2),n("div",J,[d(h,{event:f},null,8,["event"])])]))),128))],2))),128)):(a(),r("h4",O,m(i.i18n("No activity found")),1)),s.feed.length?(a(),r("div",K,[n("button",{class:_(["button",{"is-loading":s.loading}]),onClick:t[0]||(t[0]=o=>e.$emit("load-more"))},m(i.i18n("Load more")),3)])):w("",!0)])}const X=g(U,[["render",Q]]),Y={name:"Filters",components:{EnsoDateFilter:C,SelectFilter:F},inject:["i18n"],props:{loading:{type:Boolean,required:!0},filters:{type:Object,required:!0}},computed:{...$(["enums"])},watch:{filters:{handler(){this.$emit("reload")},deep:!0}}},Z={class:"icon"},ee={class:"box p-2 raises-on-hover has-background-light"},te={class:"has-text-centered"};function se(e,t,s,p,v,i){const u=c("fa"),h=c("enso-date-filter"),o=c("select-filter");return a(),r("div",null,[n("button",{class:_(["button is-fullwidth",{"is-loading":s.loading}]),onClick:t[0]||(t[0]=l=>e.$emit("reload"))},[n("span",null,m(i.i18n("Reload")),1),n("span",Z,[d(u,{icon:"sync-alt"})])],2),d(h,{class:"box raises-on-hover mt-3",value:"today",onUpdate:t[1]||(t[1]=l=>s.filters.interval=l)}),n("div",ee,[n("p",te,[n("strong",null,m(i.i18n("What")),1)]),d(o,{multiple:"",source:"system.roles.options",placeholder:i.i18n("Roles"),modelValue:s.filters.roleIds,"onUpdate:modelValue":t[2]||(t[2]=l=>s.filters.roleIds=l)},null,8,["placeholder","modelValue"]),d(o,{multiple:"",source:"administration.users.options",label:"person.name",placeholder:i.i18n("Authors"),modelValue:s.filters.userIds,"onUpdate:modelValue":t[3]||(t[3]=l=>s.filters.userIds=l)},null,8,["placeholder","modelValue"]),d(o,{multiple:"",options:e.enums.loggableEvents._select(),placeholder:i.i18n("Events"),modelValue:s.filters.events,"onUpdate:modelValue":t[4]||(t[4]=l=>s.filters.events=l)},null,8,["options","placeholder","modelValue"])])])}const ne=g(Y,[["render",se]]),ie={meta:{breadcrumb:"activity log",title:"Activity Log"},inject:["errorHandler","route"],components:{Timeline:X,Filters:ne},data:()=>({loading:!1,axiosRequest:null,feed:[],offset:0,filters:{userIds:[],roleIds:[],interval:{min:null,max:null},events:[]}}),methods:{fetch(){this.loading=!0,this.axiosRequest&&this.axiosRequest.cancel(),this.axiosRequest=axios.CancelToken.source(),axios.get(this.route("core.activityLogs.index"),{params:{offset:this.offset,filters:this.filters},cancelToken:this.axiosRequest.token}).then(({data:e})=>{const t=this.length(e);this.offset===0?this.feed=e:this.merge(e),this.offset+=t,this.loading=!1,this.ready=!0}).catch(e=>{if(axios.isCancel(e)){this.axiosRequest=null;return}this.errorHandler(e)})},length(e){return e.reduce((t,{entries:s})=>t+=s.length,0)},merge(e){e.length&&(this.feed[this.feed.length-1].date===e[0].date&&this.feed[this.feed.length-1].entries.push(...e.shift().entries),this.feed.push(...e))}}},oe={class:"columns is-reverse-mobile"},le={class:"column is-two-thirds"};function ae(e,t,s,p,v,i){const u=c("timeline"),h=c("filters");return a(),r("div",oe,[n("div",le,[d(u,{loading:e.loading,feed:e.feed,onLoadMore:t[0]||(t[0]=o=>i.fetch())},null,8,["loading","feed"])]),d(h,{class:"column is-one-third",loading:e.loading,filters:e.filters,onReload:t[1]||(t[1]=o=>{e.offset=0,i.fetch()})},null,8,["loading","filters"])])}const pe=g(ie,[["render",ae]]);export{pe as default};
